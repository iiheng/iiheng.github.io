---
title: 详情页只能解析算法的实现
date: 2022-03-21 21:10:25
tags:
---
## 前言
## 页面智能解析简介
### 实例引入
### 页面智能解析
### 业界发展
### 总结

## 详情页智能解析算法简介
### 怎样的页面属于详情页
### 提取内容
### 准备巩固走
### 提取标题
### 提取正文
### 提取发布时间
### 总结

## 详情页智能解析算法的实现
### 本节目标
### 准备工作
```
from lxml.html import HtmlElement,fromstring

html = open('detail.html',encoding='utf-8').read()
element = fromstring(html=html)
```
### 提取标题
```
METAS = [
    '//meta[starts-with(@property,"og:title")]/@content',
    '//meta[starts-with(@name,"og:title")]/@content',
    '//meta[starts-with(@property,"title")]/@content',
    '//meta[starts-with(@name,"title")]/@content',
    '//meta[starts-with(@property,"page:title")]/@content'
]
```
```
def extract_by_meta(element: HtmlElement) ->str:
    for xpath in METAS:
        title = element.xpath
        if title :
            return ''.join(title)
```

```
def extract_by_title(element:HtmlElement):
    return ''.join(element.xpath('//title//text()')).strip()

def extract_by_h(element: HtmlElement):
    hs = element.xpath('//h1//text()|//h2//text()|//h3//text()')
    return hs or []
```

```
title_extracted_by_meta = extract_by_meta(element)
title_extract_by_title = extract_by_title(element)
title_extract_by_h = extract_by_h(element)
print(title_extract_by_h,title_extract_by_title,title_extracted_by_meta,sep="\n")
```

```
def similarity(s1,s2):
    if not s1 or not s2:
        return 0
    s1_set = set(list(s1))
    s2_set = set(list(s2))
    intersection = s1_set.intersection(s2_set)
    union = s1_set.union(s2_set)
    return len(intersection) / union
```

```
def extract_title(elemet:HtmlElement):
    title_extracted_by_meta = extract_by_meta(element)
    title_extract_by_title = extract_by_title(element)
    title_extract_by_h = extract_by_h(element)

    if title_extracted_by_meta:
        return title_extracted_by_meta

    title_extract_by_h = sorted(title_extract_by_h,key=lambda x:similarity(x,title_extract_by_title),reverse=True)

    if title_extract_by_h:
        return title_extract_by_h[0]

    return title_extract_by_title
```

### 提取正文
```
from lxml.html import etree
def preprocess4content(element: HtmlElement):
    etree.strip_elements(element,*CONTENT_USELESS_TAGS)
    etree.strip_tags(element,*CONTENT_STRIP_TAGS)
    remove_children(element,CONTENT_NOIST_XPATHS)
    for child in children(element):
        if child.tag.lower() == 'p':
            etree.strip_tags(child,'span')
            etree.strip_tags(child,'strong')

            if not (child.text and child.text.strip()):
                remove_element(child)

        if child.tag.lower() == 'div' and not child.getchildren():
            child.tag = 'p'

def remove_element(element:HtmlElement):
    parent = element.getparent()
    if parent is not None:
        parent.remove(element)

def remove_children(element: HtmlElement,xpaths = None):
    if not xpaths:
        return
    for xpath in xpaths:
        nodes = element.xpath(xpath)
        for node in nodes:
            remove_element(node)
    return element

def children(element:HtmlElement):
    yield element
    for child_element in element:
        if isinstance(child_element,HtmlElement):
            yield from children(child_element)
```
