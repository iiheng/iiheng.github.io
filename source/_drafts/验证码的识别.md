---
title: 验证码的识别
date: 2022-02-27 17:40:31
tags: 
categories: python爬虫的学习
---
## 前言
- 爬虫文章均来自《python3网络爬虫开发实战教程》，只为方便记录日常所学，以及方便观看。

## 使用OCR技术识别图形验证码
### OCR技术
### 准备工作
`pip3 install selenium pillow numpy retrying`
### 保存验证码图片
### 识别测试
```
import tesserocr
from PIL import Image

image = Image.open('captcha.png')
result = tesserocr.image_to_text(image)
print(result)
```

	 a 9Ad,
	 
### 处理验证码
```
import tesserocr
from PIL import Image
import numpy as np

image = Image.open('captcha.png')
print(np.array(image).shape)
print(image.mode)
```

	(38, 112, 4)
	RGBA
	
```
image = image.convert("L")
image.show()
```

```
image = image.convert("1")
image.show()
```

```
import tesserocr
from PIL import Image
import numpy as np

image = Image.open('captcha.png')
image = image.convert("L")
threshold = 90
array = np.array(image)
array = np.where(array > threshold,255,0)
image = Image.fromarray(array.astype('uint8'))
image.show()
```

```
import tesserocr
from PIL import Image
import numpy as np

image = Image.open('captcha.png')
image = image.convert("L")
threshold = 90
array = np.array(image)
array = np.where(array > threshold,255,0)
image = Image.fromarray(array.astype('uint8'))
result = tesserocr.image_to_text(image)
print(result)
```

## 使用OpenCV识别滑动验证码的缺口
### 滑动验证码
### 基本原理
### 准备工作
`pip install opencv-python`

### 高斯滤波
`def GaussianBlur(src,ksize,sigmaX,dst=None,signmaY=None,borderType=None)`

### 边缘检测
`def Canny(image,threshold1,threshold2,edges=None,apertureSize=None,L2gradient=None)`

### 轮廓提取
`def findContours(image,mode,method,contours=None,hierarchy=None,offset=None)`

### 外接矩形
`def boundingRect(array)`

### 轮廓面积
`def contourArea(contour,oriented=None)`

### 轮廓周长
`def arcLength(curve,closed)`

### 缺口识别
```
import cv2

GUASSIAN_BLUR_KERNEL_SIZE=(5,5)
GUASSIAN_BLUR_SIGMA_X=0
CANNY_THRESHOLD1 = 200
CANNY_THRESHOLD2 = 450

def get_gaussian_blur_image(image):
    return cv2.GaussianBlur(image,GUASSIAN_BLUR_KERNEL_SIZE,GUASSIAN_BLUR_SIGMA_X)

def get_canny_image(image):
    return cv2.Canny(image,CANNY_THRESHOLD1,CANNY_THRESHOLD2)

def get_contours(image):
    contours,_ = cv2.findContours(image,cv2.RETR_CCOMP,cv2.CHAIN_APPROX_SIMPLE)
    return contours
```

```
image_raw = cv2.imread("captcha2.png")
image_height,image_width,_ = image_raw.shape
image_gaussian_blue = get_gaussian_blur_image(image_raw)
cv2.imwrite("gaussian.png",image_gaussian_blue)
image_canny = get_canny_image(image_gaussian_blue)
cv2.imwrite("canny.png",image_canny)
contours = get_contours(image_canny)
```

```
def get_contour_area_threshold(image_width,image_height):
    contour_area_min = (image_width*0.15)*(image_height*0.25)*0.8
    contour_area_max = (image_width * 0.15) * (image_height * 0.25) * 1.2
    return contour_area_min,contour_area_max

def get_arc_length_threshold(image_width,image_height):
    arc_length_min = ((image_width*0.15)+(image_height*0.25))*0.8*2
    arc_length_max = ((image_width*0.15)+(image_height*0.25))*1.2*2
    return arc_length_min,arc_length_max

def get_offset_threshold(image_width):
    offset_min = 0.2*image_width
    offset_max = 0.85*image_width
    return offset_min,offset_max
```

```
contour_area_min,contour_area_max = get_contour_area_threshold(image_width,image_height)
arc_length_min,arc_length_max = get_arc_length_threshold(image_width,image_height)
offset_min,offset_max = get_offset_threshold(image_width)
offset = None
print(f"area:{contour_area_min}-{contour_area_max},arc:{arc_length_min}-{arc_length_max},offset:{offset_min}-{offset_max}")
for contour in contours:
    x,y,w,h = cv2.boundingRect(contour)
    area_contour=cv2.contourArea(contour)
    arc_length = cv2.arcLength(contour,True)
    print(area_contour,arc_length,x)
    if contour_area_min < area_contour < contour_area_max and arc_length_min<arc_length<arc_length_max and offset_min < x <offset_max:
        cv2.rectangle(image_raw,(x,y),(x+w,y+h),(0,0,255),2)
        offset = x

cv2.imwrite('image_label.png',image_raw)
print('offset',offset)
```

### 总结

## 使用深度学习识别图形验证码

### 准备工作
`pip3 install torch torchvision`

`pip3 install captcha`

## 使用深度学习识别滑动验证码的缺口

## 使用打码平台识别验证码
### 准备工作
`pip3 install opencv-python pillow`
`git clone https://github.com/Python3WebSpider/CaptchaPlatform.git`

```
import requests
from hashlib import md5


class Chaojiying(object):
    
    def __init__(self, username, password, soft_id):
        self.username = username
        self.password = md5(password.encode('utf-8')).hexdigest()
        self.soft_id = soft_id
        self.base_params = {
            'user': self.username,
            'pass2': self.password,
            'softid': self.soft_id,
        }
        self.headers = {
            'User-Agent': 'Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 5.1; Trident/4.0)',
        }
    
    def post_pic(self, im, codetype):
        """
        im: 图片字节
        codetype: 题目类型 参考 http://www.chaojiying.com/price.html
        """
        params = {
            'codetype': codetype,
        }
        params.update(self.base_params)
        files = {'userfile': ('ccc.jpg', im)}
        r = requests.post('http://upload.chaojiying.net/Upload/Processing.php', data=params, files=files,
                          headers=self.headers)
        return r.json()
    
    def report_error(self, im_id):
        """
        im_id:报错题目的图片ID
        """
        params = {
            'id': im_id,
        }
        params.update(self.base_params)
        r = requests.post('http://upload.chaojiying.net/Upload/ReportError.php', data=params, headers=self.headers)
        return r.json()
```

### 图形验证码
```
from chaojiying import Chaojiying

username = 'iiheng'
password = '1269305589wyh'
soft_id = '929667'
captcha_kind = '1006'
file_name = 'captcha1.png'
client = Chaojiying(username,password,soft_id)
result = client.post_pic(open(file_name,'rb').read(),captcha_kind)
print(result)
```

	{'err_no': 0, 'err_str': 'OK', 'pic_id': '8170408318063400002', 'pic_str': '6M44NN', 'md5': 'b79bd1955a61cc094432136b18bfdf8c'}
	
### 点选验证码

	{'err_no': 0, 'err_str': 'OK', 'pic_id': '1170408458063400005', 'pic_str': '106,132|203,147', 'md5': '33cc016a12f8816637440466fb09f7af'}
	
```
import cv2

image = cv2.imread('captcha2.png')
image = cv2.circle(image, (125, 137), radius=10, color=(255, 0, 0), thickness=-1)
image = cv2.circle(image, (228, 138), radius=10, color=(255, 0, 0), thickness=-1)
cv2.imwrite('captcha2_label.png', image)
```

### 滑动验证码

	{'err_no': 0, 'err_str': 'OK', 'pic_id': '8170408508063400007', 'pic_str': '205,85', 'md5': '189030ecebba99921e1f7f1f83fdb4b6'}

	{'err_no': 0, 'err_str': 'OK', 'pic_id': '8170408538063400008', 'pic_str': '217,103', 'md5': 'e211f165334a5e62215dde6346a33b48'}
		
	{'err_no': 0, 'err_str': 'OK', 'pic_id': '1170408578063400010', 'pic_str': '大象', 'md5': '8d77b8261ccc30ff8f5f7d6c6a273f5f'}
	
	
### 手机验证码的自动化处理
```
from flask import Flask,request,jsonify
from loguru import logger

app = Flask(__name__)

@app.route('/sms',methods=['post'])
def receuve():
    sms_content = request.form.get('content')
    logger.debug(f'received{sms_content}')
    return jsonify(status = 'success')

if __name__=='__main__':
    app.run(debug=True)
```

	 * Restarting with stat
	 * Debugger is active!
	 * Debugger PIN: 109-522-594
	 * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)


`ngrok.exe http 5000`
