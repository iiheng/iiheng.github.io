---
title: 数据的存储
date: 2022-02-16 14:49:53
tags: 数据的存储
categories: python爬虫的学习
---
## 前言
- 爬虫文章均来自《python3网络爬虫开发实战教程》，只为方便记录日常所学，以及方便观看。

## TXT文本文件存储
### 本节目标
我们以电影实例网站https://ssr1.scrape.center/为例，爬取首页10部电影的数据，然后将相关信息存储为TXT文本格式。

### 基本实例

```
import requests
from pyquery import PyQuery as pq
import re

url = 'http://ssr1.scrape.center'
html = requests.get(url).text
doc = pq(html)
items = doc('.el-card').items()
file = open('movie.txt','w',encoding='utf-8')
for item in items:
    # 电影名称
    name = item.find('a > h2').text()
    file.write(f"名称：{name} \n")
    # 类别
    categories = [item.text() for item in item.find('.categories button span').items()]
    file.write(f"类别：{categories} \n")
    # 上映时间
    publish_at = item.find('.info:contains(上映)').text()
    publish_at = re.search('(\d{4}-\d{2}-\d{2})',publish_at).group(1) if publish_at and re.search('(\d{4}-\d{2}-\d{2})',publish_at) else None
    file.write(f"上映时间：{publish_at}\n")
    # 评分
    score = item.find('p.score').text()
    file.write(f'评分：{score}\n')
    file.write(f'{"="*50}\n')
file.close()
```

	名称：霸王别姬 - Farewell My Concubine 
	类别：['剧情', '爱情'] 
	上映时间：1993-07-26
	评分：9.5
	==================================================
	名称：这个杀手不太冷 - Léon 
	类别：['剧情', '动作', '犯罪'] 
	上映时间：1994-09-14
	评分：9.5
	==================================================
	名称：肖申克的救赎 - The Shawshank Redemption 
	类别：['剧情', '犯罪'] 
	..........
	
### 打开方式
|模式|含义|
|:---:|:----:|
|`r`|以只读的方式打开一个文件，意思是只能读取文件内容，而不能写入。这也是默认模式|
|`w`|以写入方式打开一个文件。如果该文件已存在，则将其覆盖。如果改文件不存在，则创建新文件|
|`a`|以追加方式打开一个文件。如果该文件已存在，则文件指针将会放在文件末尾。也就是说，新的内容将会被写到已有内容之后。如果改文件不存在，则创建新文件来写入。|
|`b`|以二进制的方式打开一个文件|
|`+`|以读写的方式打开一个文件|
|常用|`r`、`rb`、`r+`、`rb+`、`w`、`wb`、`w+`、`wb+`、`a`、`ab`、`a+`、`ab+`|

```
with open('movie.txt','w',encoding='utf-8') as file:
    for item in items:
        # 电影名称
        name = item.find('a > h2').text()
        file.write(f"名称：{name} \n")
        # 类别
        categories = [item.text() for item in item.find('.categories button span').items()]
        file.write(f"类别：{categories} \n")
        # 上映时间
        publish_at = item.find('.info:contains(上映)').text()
        publish_at = re.search('(\d{4}-\d{2}-\d{2})',publish_at).group(1) if publish_at and re.search('(\d{4}-\d{2}-\d{2})',publish_at) else None
        file.write(f"上映时间：{publish_at}\n")
        # 评分
        score = item.find('p.score').text()
        file.write(f'评分：{score}\n')
        file.write(f'{"="*50}\n')
```

### 总结
## JSON文件储存
### 对象和数组
### 读取JSON
```
import json

str = """
[
  {
    "name": "Bob",
    "gender": "male",
    "birthday": "1992-10-18"
  },{
  "name": "Selina",
  "gender": "female",
  "birthday": "1995-10-18"
}
]
"""
print(type(str))
data = json.loads(str)
print(data)
print(type(data))
```

	<class 'str'>
	[{'name': 'Bob', 'gender': 'male', 'birthday': '1992-10-18'}, {'name': 'Selina', 'gender': 'female', 'birthday': '1995-10-18'}]
	<class 'list'>

```
print(data[0]['name'])
print(data[0].get('name'))
```

	Bob
	Bob
	
```
print(data[0].get('age'))
print(data[0].get('age',25))
```

```
import json

str = """
[
  {
    'name': 'Bob',
    'gender': 'male',
    'birthday': '1992-10-18'
  },{
  'name': 'Selina',
  'gender': 'female',
  'birthday: '1995-10-18
}
]
"""
data = json.loads(str)
```

	json.decoder.JSONDecodeError: Expecting property name enclosed in double quotes: line 4 column 5 (char 11)
	
```
import json
with open('test.json',encoding='utf-8') as file:
    str = file.read()
    data = json.loads(str)
    print(data)
```

	[{'name': 'Bob', 'gender': 'male', 'birthday': '1992-10-18'}, {'name': 'Selina', 'gender': 'female', 'birthday': '1995-10-18'}]
	
```
import json

data = json.load(open('test.json',encoding='utf-8'))
print(data)
```

### 输出JSON
```
import json

data = [
  {
    "name": "Bob",
    "gender": "male",
    "birthday": "1992-10-18"
  }
]
with open('data.json','w',encoding="utf-8") as file:
    file.write(json.dumps(data))
```

	[{"name": "Bob", "gender": "male", "birthday": "1992-10-18"}]

```
with open('data.json','w',encoding="utf-8") as file:
    file.write(json.dumps(data,indent=2))
```

	[
	  {
		"name": "Bob",
		"gender": "male",
		"birthday": "1992-10-18"
	  }
	]

```
import json

data = [
  {
    "name": "李四",
    "gender": "男",
    "birthday": "1992-10-18"
  }
]
with open('data.json','w',encoding="utf-8") as file:
    file.write(json.dumps(data,indent=2))
```

	[
	  {
		"name": "\u674e\u56db",
		"gender": "\u7537",
		"birthday": "1992-10-18"
	  }
	]

```
with open('data.json','w',encoding="utf-8") as file:
    file.write(json.dumps(data,indent=2,ensure_ascii=False))
```

	[
	  {
		"name": "李四",
		"gender": "男",
		"birthday": "1992-10-18"
	  }
	]
	
```
json.dump(data,open('data.json','w',encoding='utf-8'),indent=2,ensure_ascii=False)
```

## CSV文件存储
### 写入
```
import csv

with open('data.csv','w',newline='') as csvfile:
  writer = csv.writer(csvfile)
  writer.writerow(['id','name','age'])
  writer.writerow(['10001','Mike',20])
  writer.writerow(['10002','Bob',22])
  writer.writerow(['10003','Jordan',21])
```

	id,name,age
	10001,Mike,20
	10002,Bob,22
	10003,Jordan,21
	
```
import csv

with open('data.csv','w',newline='') as csvfile:
  writer = csv.writer(csvfile,delimiter=" ")
  writer.writerow(['id','name','age'])
  writer.writerow(['10001','Mike',20])
  writer.writerow(['10002','Bob',22])
  writer.writerow(['10003','Jordan',21])
```

	id name age
	10001 Mike 20
	10002 Bob 22
	10003 Jordan 21
	
```
import csv

with open('data.csv','w',newline='') as csvfile:
  writer = csv.writer(csvfile)
  writer.writerow(['id','name','age'])
  writer.writerows([['10001','mike',20],['10002','bob',22],['10003','lisa',21]])
```

	id,name,age
	10001,mike,20
	10002,bob,22
	10003,lisa,21

```bash
import csv

with open('data.csv','w',newline='') as csvfile:
  fieldnames = ['id','name','age']
  writer = csv.DictWriter(csvfile,fieldnames=fieldnames)
  writer.writeheader()
  writer.writerow({'id':'10001',"name":'Mike',"age":20})
  writer.writerow({'id':'10001',"name":'Bob',"age":22})
  writer.writerow({'id':'10001',"name":'Jordan',"age":24})
```

	id,name,age
	10001,Mike,20
	10001,Bob,22
	10001,Jordan,24

```bash
import csv

with open('data.csv','a',newline='') as csvfile:
  fieldnames = ['id','name','age']
  writer = csv.DictWriter(csvfile,fieldnames=fieldnames)
  writer.writerow({'id':'10004',"name":'Doubi',"age":20})
```

	id,name,age
	10001,Mike,20
	10001,Bob,22
	10001,Jordan,24
	10004,Doubi,20

```bash
import csv

with open('data.csv','a',newline='',encoding='utf-8') as csvfile:
  fieldnames = ['id','name','age']
  writer = csv.DictWriter(csvfile,fieldnames=fieldnames)
  writer.writerow({'id':'10001',"name":'李四',"age":20})
```

```bash
import pandas as pd

data = [
  {'id':'10001','name':'Mike','age':25},
  {'id': '10002', 'name': 'Bob', 'age': 22},
  {'id': '10003', 'name': 'lisa', 'age': 21},
]

df = pd.DataFrame(data)
df.to_csv('data.csv',index=False)
```
### 读取
```
import csv

with open('data.csv','r',encoding='utf-8') as csvfile:
  reader = csv.reader(csvfile)
  for row in reader:
    print(row)
```

	['id', 'name', 'age']
	['10001', 'Mike', '25']
	['10002', 'Bob', '22']
	['10003', 'lisa', '21']
	
```
import pandas as pd

df = pd.read_csv('data.csv')
print(df)
```

		  id  name  age
	0  10001  Mike   25
	1  10002   Bob   22
	2  10003  lisa   21
	
```bash
import pandas as pd

df = pd.read_csv('data.csv')
for index,row in df.iterrows():
  print(row.tolist())
```

	[10001, 'Mike', 25]
	[10002, 'Bob', 22]
	[10003, 'lisa', 21]
	
## MySQL 存储
### 准备工作
### 连接数据库
```bash
import pymysql

db = pymysql.connect(host='localhost',user='root',password='123456',port=3306)
cursor = db.cursor()
cursor.execute('select version()')
data = cursor.fetchone()
print('database version:',data)
cursor.execute('create database spiders default character set utf8mb4')
db.close()
```

	database version: ('8.0.26',)
	
### 创建表
```
import pymysql

db = pymysql.connect(host='localhost',user='root',password='123456',port=3306,db='spiders')
cursor = db.cursor()
sql = 'create table if not exists students(id varchar(255) not null,name varchar(255) not null,age int not null,primary key (id))'
cursor.execute(sql)
db.close()
```
### 插入数据
```
import pymysql

id = "2012001"
user = "Bob"
age = 20

db = pymysql.connect(host='localhost',user='root',password='1360630934wyh',port=3306,db='spiders')
cursor = db.cursor()
sql = 'insert into students(id,name,age) values (%s,%s,%s)'
try:
    cursor.execute(sql,(id,user,age))
    db.commit()
    print('插入成功')
except:
    print("插入失败")
    db.rollback()
db.close()
```

```
import pymysql

db = pymysql.connect(host='localhost',user='root',password='1360630934wyh',port=3306,db='spiders')
cursor = db.cursor()
data = {
    "id" : "2012001",
    "name" : "Bob",
    "age" : 20
}
table = "students"
keys = ','.join(data.keys())
values = ','.join(['%s']*len(data))
sql = "insert into {table}({keys}) values ({values})".format(table=table,keys=keys,values=values)
print("sql语句：",sql)
try:
    if cursor.execute(sql,tuple(data.values())):
        print("successful")
        db.commit()
except:
    print("failed")
    db.rollback()
db.close()
```

	sql语句： insert into students(id,name,age) values (%s,%s,%s)
	successful
	
### 更新数据
```
import pymysql

db = pymysql.connect(host='localhost',user='root',password='123456',port=3306,db='spiders')
cursor = db.cursor()
sql = "update students set age = %s where name = %s"
try:
    cursor.execute(sql,(25,'BOb'))
    db.commit()
except:
    db.rollback()
db.close()
```

```
import pymysql

db = pymysql.connect(host='localhost',user='root',password='1360630934wyh',port=3306,db='spiders')
cursor = db.cursor()
data = {
    'id':'20120001',
    'name':'Bob',
    'age':54
}

table = 'students'
keys = ','.join(data.keys())
values = ','.join(['%s']*len(data))
sql = 'insert into {table}({keys}) values ({values}) on duplicate key update '.format(table=table,keys=keys,values=values)
update = ','.join(["{key}=%s".format(key=key)for key in data])
sql += update
try:
    if cursor.execute(sql,tuple(data.values())*2):
        print('successful')
        db.commit()
    else:
        print('数据没有变化')
except:
    print('failed')
    db.rollback()
db.close()
```

`insert into students(id,name,age) values (%s,%s,%s) on duplicate key update id=%s,name=%s,age=%s`

### 删除数据
```
table = "students"
condition = 'age > 20'
sql = f'delete from {table} where {condition}'
try:
    cursor.execute(sql)
    db.commit()
except:
    db.rollback()
```

### 查询数据
```
import pymysql

db = pymysql.connect(host='localhost',user='root',password='1360630934wyh',port=3306,db='spiders')
cursor = db.cursor()
sql = "select * from students where age >=20"
try:
    cursor.execute(sql)
    print('Count:',cursor.rowcount)
    one = cursor.fetchone()
    print('One:',one)
    result = cursor.fetchall()
    print("result:",result)
    print("result type:",type(result))
    for row in result:
        print(row)
except:
    print("Error")
```

	Count: 4
	One: ('20120001', 'Bob', 25)
	result: (('20120011', 'Mary', 21), ('20120012', 'Mike', 20), ('20120013', 'James', 22))
	result type: <class 'tuple'>
	('20120011', 'Mary', 21)
	('20120012', 'Mike', 20)
	('20120013', 'James', 22)
	
```
sql = "select * from students where age >=20"
try:
    cursor.execute(sql)
    print('Count:',cursor.rowcount)
    row = cursor.fetchone()
    while row:
        print('Row:',row)
        row = cursor.fetchone()
except:
    print("Error")
```
### 总结

## MongoDB 文档存储
### 准备工作
### 连接MongoDB
```
import pymongo
client = pymongo.MongoClient(host='localhost',port=27017)
```
```
client = pymongo.MongoClient('mongodb://localhost:27017/')
```
### 指定数据库
`db = client.test`
`db = client['test']`
### 指定集合
`collection = db.students`
`collection = db['students']`
### 插入数据
```
student = {
    "id":'20170101',
    'name':'Jordan',
    'age':20,
    'gender':'male'
}
result = collection.insert_one(student)
print(result)
print()
```
```
import pymongo
client = pymongo.MongoClient(host='localhost',port=27017)
db = client['test']
collection = db.students
student = {
    "id":'20170101',
    'name':'Jordan',
    'age':20,
    'gender':'male'
}
student2 = {
    "id":'20170102',
    'name':'Jordan',
    'age':20,
    'gender':'male'
}
result = collection.insert_many([student,student2])
print(result)
print(result.inserted_ids)
```

	<pymongo.results.InsertManyResult object at 0x000001D5A8641180>
	[ObjectId('620dfd63bc30cd00a1871024'), ObjectId('620dfd63bc30cd00a1871025')]
	
### 查询
```
result = collection.find_one({'name':'Mike'})
print(type(result))
print(result)
```

	<class 'dict'>
	{'_id': ObjectId('620e097019ab150ec0383f86'), 'id': '20170102', 'name': 'Mike', 'age': 23, 'gender': 'male'}

```
from bson.objectid import ObjectId
result = collection.find_one({'_id':ObjectId('620e097019ab150ec0383f86')})
print(result)
```

	{'_id': ObjectId('620e097019ab150ec0383f86'), 'id': '20170102', 'name': 'Mike', 'age': 23, 'gender': 'male'}
	
```
results = collection.find({'age':20})
for result in results:
    print(result)
```

```
results = collection.find({'age':{'$gt':19}})
for result in results:
    print(result)
```

|符号|含义|实例|
|----|-----|-----|
|`$lt`|小于|{'age':{'$lt':20}}|
|`$gt`|大于|{'age':{'$gt':20}}|
|`$lte`|小于等于|{'age':{'$lte':20}}|
|`$gte`|大于等于|{'age':{'$gte':20}}|
|`$ne`|不等于|{'age':{'$ne':20}}|
|`$in`|在范围内|{'age':{'$in':20}}|
|`$nin`|小于|{'age':{'$nin':20}}|

```
results = collection.find({'name':{'$regex':'^M.*'}})
```

|符号|含义|实例|实例含义|
|----|----|----|-----|
|`$regex`|匹配正则表达式|{'name':{'$regex':'^M.*'}}|name以M开头|
|`$exists`|属性是否存在|{'name':{'$exists':True}}|存在name属性|
|`$type`|类型判断|{'age':{'$type':'int'}}|age的类型为 int|
|`$mod`|数字模操作|{'age':{'$mod':[5,0]}}|age模5余0|
|`$text`|文本查询|{'$text':{'$search':'Mike'}}|Mike字符串|
|`$where`|高级条件查询|{'$where':'obj.fans_count==obj.follows_count'}|自身粉丝数等于关注数|

### 排序
```
results = collection.find().sort('name',pymongo.ASCENDING)
print([result['name'] for result in results])
```

	['Jordan', 'Mike']
	
### 偏移
```
results = collection.find().sort('name',pymongo.ASCENDING).skip(1)
print([result['name'] for result in results])
```

	['Mike']
	
```
results = collection.find().sort('name',pymongo.ASCENDING).limit(1)
print([result['name'] for result in results])
```

	['Jordan']
	
### 更新
```
condition = {'name':'Mike'}
student = collection.find_one(condition)
student['age'] = 25
result = collection.update_one(condition,{'$set':student})
print(result)
print(result.matched_count,result.modified_count)
```

```
condition = {'age':{'$gt':20}}
result = collection.update_one(condition,{'$inc':{'age':1}})
print(result)
print(result.matched_count,result.modified_count)
```

	<pymongo.results.UpdateResult object at 0x0000016BB4CB6E00>
	1 1
	
```
condition = {'age':{'$gt':20}}
result = collection.update_many(condition,{'$inc':{'age':1}})
print(result)
print(result.matched_count,result.modified_count)
```

	<pymongo.results.UpdateResult object at 0x000002B692982380>
	2 2
	
### 删除
```
result = collection.delete_one({'name':"Kevin"})
print(result)
print(result.deleted_count)
result = collection.delete_many({'age':{'$lt':25}})
print(result.deleted_count)
```

	<pymongo.results.DeleteResult object at 0x0000018CAA827EC0>
	0
	1
	
### 其他操作
### 总结


## Redis 缓存存储
### 准备工作
`pip install redis`
### Redis 和StrickRedis
### 连接Redis
```
from redis import StrictRedis
redis = StrictRedis(host="localhost",port=6379,db=0,password='1269305589wyh')
redis.set('name','Bob')
print(redis.get('name'))
```

	b'Bob'
	
```
pool = ConnectionPool(host="localhost",port=6379,db=0,password="1269305589wyh")
redis = StrictRedis(connection_pool=pool)
print(redis.get('name'))
```

`redis://[:password]@host:port/db`
`rediss://[:password]@host:port/db`
`unix://[:password]@/path/to/socket.sock?db=db`

```
url = "redis://:1269305589wyh@localhost:6379/0"
pool = ConnectionPool.from_url(url)
redis = StrictRedis(connection_pool=pool)
print(redis.get('name'))
```
### 键操作
|方法|作用|参数说明|实例|实例说明|实例结果|
|---|----|-------|-----|-------|--------|
|`exists(name)`|判断一个键是否存在|name:键名|redis.exists('name')|是否存在那么这个键|1|
|`delete(name)`|删除一个键|name:键名|redis.delete('name')|删除name这个键|1|
|`type(name)`|判断键类型|name:键名|redis.type('name')|判断name这个键的类型|b'string'|
|`keys(pattern)`|获取所有符合规则的键|pattern:匹配规则|redis.keys('n*')|获取所有以n开头的键|[b'name']|
|`randomkey()`|获取随机的一个键||redis.randomkey()|获取随机的一个键|b'name'|
|`rename(src,dst)`|对键重命名|src:原键名dst:新键名|redis.rename('name','nickname')|将name重命名为nickname|True|
|`dbsize()`|获取当前数据库中键的数目||redis.dbsize()|获取当前数据库中键的数目|100|
|`expire(name,time)`|设定键的过期时间，时间为秒|name:键名time:秒数|expire('name',2)|将name键的过期时间设置为2秒|True|
|`ttl(name)`|获取键的过期时间|name:键名|redis.ttl('name')|获取name这个键的过期时间|-1(-1表示永不过期)|
|`move(name,db)`|将键移动到其他数据库|name:键名db:移往的数据库代号|redis.move('name',2)|将name键移动到2号数据库|True|
|`flushdb()`|删除当前所选数据库中的所有键||redis.flushdb()|删除当前所选数据库中的所有键|true|
|`flushall()`|删除所有数据库中的所有键||redis.flushall()|删除所有数据库中的所有键|True|


### 字符串操作
|方法|作用|参数说明|实例|实例说明|实例结果|
|-----|-----|-----|----|------|------|
|`set(name,vlaue)`|将数据库中制定键名对应的键值赋值为字符串value|name:键名value:键值|redis.set('name','Bob')|将name这个键对应的键值赋值为Bob|True|	
|`get(name)`|返回数据库中指定键名对应的键值|name:键名|redis.get('name')|返回name这个键对应的键值|b'Bob'|
|`getset(name,value)`|将数据库中指定键名对应的键值赋值为字符串value，并返回上次的value|name:键名value:新值|redis.getset('name','Mike')|将name这个键对应的键值赋值为Mike，并返回上次的value|b'Bob'|
|`mget(keys,*args)`|返回由多个键名对应的value组成的列表|keys:键名序列|redis.mget('name','nickname')|返回name和nickname对应的value|[b'Mike', b'Miker']|
||||redis.setnx('newname','James')||True|
||||redis.setex('newname',60,'James')||True|
||||redis.setrange('name',6,'World')||11|
||||redis.mset({'name1':'Durant','name2':'James'})||True|
||||redis.msetnx({'name1':'Durant','name2':'James'})||True|
||||redis.incr('age',1)||2|
||||redis.decr('age',1)||1|
||||redis.append('nickname','OK')||7|
||||redis.substr('nickname',2,5)||b'kerO'|
||||redis.getrange('nickname',2,5)||b'kerO'|

### 列表操作
|方法|作用|参数说明|实例|实例说明|实例结果|
|-----|-----|-----|----|------|------|
||||redis.rpush('list',1,2,3)||3|
||||redis.lpush('list',0)||4|
||||redis.llen('list')||[b'1', b'2', b'3']|
||||redis.lrange('list',1,3)||[b'0', b'1', b'2']|
||||redis.ltrim('list',1,3)||True|
||||redis.lindex('list',1)||b'1'|
||||redis.lset('list',1,6)||True|
||||redis.lrem('list',2,6)||b'1'|
||||redis.lpop('list')||b'5'|
||||redis.blpop('list')||[]b'5']|
||||redis.brpop('list')||b'1'|
||||redis.rpoplpush('list','list2')||b'1'|

### 集合操作

|方法|作用|参数说明|实例|实例说明|实例结果|
|-----|-----|-----|----|------|------|
||||redis.sadd('tags','Book','Tea','Coffee')||3|
||||redis.srem('tags','Book')||1|
||||redis.spop('tags')||b'Coffee'|
||||redis.smove('tags','tags2','Coffee')||True|
||||redis.scard('tags')||3|
||||redis.sismember('tags','Tea')||True|
||||redis.sinter('tags','tags2')||{b'Coffee'}|
||||redis.sinterstore('inttag',['tags','tags2'])||3|
||||redis.sunion('tags','tags2')||{b'1', b'Coffee', b'Tea'}|
||||redis.sunionstore('uniontags',['tags','tags2'])||3|
||||redis.sdiff('tags','tags2')||{b'Tea'}|
||||redis.sdiffstore('uniontags',['tags','tags2'])||1|
||||redis.smembers('uniontags')||{b'Tea'}|
||||redis.srandmember('tags')||{b'Tea'}|

### 有序集合操作
|方法|作用|参数说明|实例|实例说明|实例结果|
|-----|-----|-----|----|------|------|
||||redis.zadd('grade',{'Bob':100,'Mike':98})||2|
||||redis.zrem('grade','Bob')||{b'Tea'}|
||||redis.zincrby('grade',3,'Bob')||103.0|
||||redis.zrank('grade','Bob')||1|
||||redis.zrevrange('grade',0,1)||[b'Iheng', b'Bob']|
||||redis.zrangebyscore('grade',0,99)||[b'Mike']|
||||redis.zcount('grade',0,99)||1|
||||redis.zcard('grade')||3|
||||redis.zremrangebyrank('grade',0,0)||1|
||||redis.zremrangebyscore('grade',0,100)||1|

### 散列操作
|方法|作用|参数说明|实例|实例说明|实例结果|
|-----|-----|-----|----|------|------|
||||redis.hset('price','cake',5)||1|
||||redis.hsetnx('price','book',5)||1|
||||redis.hget('price','book')||b'5'|
||||redis.hmget('price','book','cake')||[b'5', b'5']|
||||redis.hmset('price',{'banana2':2,'pear2':6})||True|
||||redis.hincrby('price','apple',3)||3|
||||redis.hexists('price','apple')||True|
||||redis.hdel('price','apple')||1|
||||redis.hlen('price')||6|
||||redis.hkeys('price')||[b'cake', b'book', b'banana', b'pear', b'banana2', b'pear2']|
||||redis.hvals('price')||[b'5', b'5', b'2', b'6', b'2', b'6']|
||||redis.hgetall('price')||{b'cake': b'5', b'book': b'5', b'banana': b'2',b'pear2': b'6'}|

## Elasticsearch 搜索引擎存储
### Elasticsearch 介绍
### Elasticsearch 相关概念
### 准备工作
`pip install 'elasticsearch<7.14.0'`
### 创建索引
```
from elasticsearch import Elasticsearch

es = Elasticsearch()
result = es.indices.create(index='news',ignore=400)
print(result)
```

`es = Elasticsearch(['https://[username:password@]hostname:port'])`

	{'acknowledged': True, 'shards_acknowledged': True, 'index': 'news'}

	raise HTTP_EXCEPTIONS.get(status_code, TransportError)(
	elasticsearch.exceptions.RequestError: RequestError(400, 'resource_already_exists_exception', 'index [news/YSL7v1kxSqeAgblHwTCseg] already exists')
### 删除索引
```
from elasticsearch import Elasticsearch

es = Elasticsearch()
result = es.indices.delete(index='news',ignore=[400,404])
print(result)
```

	{'acknowledged': True}
	
	raise HTTP_EXCEPTIONS.get(status_code, TransportError)(
	elasticsearch.exceptions.NotFoundError: NotFoundError(404, 'index_not_found_exception', 'no such index [news]', news, index_or_alias)
	
### 插入数据
```
from elasticsearch import Elasticsearch

es = Elasticsearch()
result = es.indices.create(index='news',ignore=[400,409])
data = {
    "title":'乘风破会有时，直挂云帆济沧海2',
    'url':'https://https://hanyu.bai5du.com/shici/detail?pid=b3c0f7fa848f494aa9e4868aa5bbcd9b&from=kg0&highlight=%E9%95%BF%E9%A3%8E%E7%A0%B4%E6%B5%AA%E4%BC%9A%E6%9C%89%E6%97%B6%EF%BC%8C%E7%9B%B4%E6%8C%82%E4%BA%91%E5%B8%86%E6%B5%8E%E6%B2%A7%E6%B5%B7',
    'data':'2022-07-05'
}
result = es.create(index='news',id=1,body=data)
print(result)
```

```
result = es.index(index='news',id=1,body=data)
```

### 更新数据
```
from elasticsearch import Elasticsearch

es = Elasticsearch()
result = es.indices.create(index='news',ignore=[400,409])
data = {
    "title":'乘风破会有时，直挂云帆济沧海2',
    'url':'https://https://hanyu.bai5du.com/shici/detail?pid=b3c0f7fa848f494aa9e4868aa5bbcd9b&from=kg0&highlight=%E9%95%BF%E9%A3%8E%E7%A0%B4%E6%B5%AA%E4%BC%9A%E6%9C%89%E6%97%B6%EF%BC%8C%E7%9B%B4%E6%8C%82%E4%BA%91%E5%B8%86%E6%B5%8E%E6%B2%A7%E6%B5%B7',
    'data':'2022-07-05'
}
result = es.update(index='news',id=1,body=data)
print(result)
```

`result = es.index(index='news',id=1,body=data)`

### 删除数据
```
from elasticsearch import Elasticsearch

es = Elasticsearch()
result = es.delete(index='news',id=1)
print(result)
```

	{'_index': 'news', '_type': '_doc', '_id': '1', '_version': 6, 'result': 'deleted', '_shards': {'total': 2, 'successful': 1, 'failed': 0}, '_seq_no': 5, '_primary_term': 2}

### 查询数据
```
from elasticsearch import Elasticsearch

es = Elasticsearch()
datas = [
    {
        'title':'成都管理措施生意 实拍街面防疫画面',
        'url':'http://k.sina.com.cn/article_7723381539_m1cc59732300100y7b6.html'
    },
{
        'title':'呼和浩特本轮疫情已外溢3市，传播链达175人',
        'url':'http://news.sina.com.cn/o/2022-02-21/doc-imcwipih4526673.shtml'
    },
{
        'title':'科普：“混打”新冠疫苗 你的理解对吗',
        'url':'http://news.sina.com.cn/o/2022-02-21/doc-imcwipih4528497.shtml'
    },
{
        'title':'新冠疫苗“混打”加强针，要注意什么？',
        'url':'http://news.sina.com.cn/c/2022-02-21/doc-imcwiwss2009819.shtml'
    }
]

for data in datas:
    es.index(index='news',body=data)
```

	
	{'took': 197, 'timed_out': False, '_shards': {'total': 1, 'successful': 1, 'skipped': 0, 'failed': 0}, 'hits': {'total': {'value': 4, 'relation': 'eq'}, 'max_score': 1.0, 'hits': [{'_index': 'news', '_type': '_doc', '_id': 'qcLVHH8BLpl_c_jRZ7DZ', '_score': 1.0, '_source': {'title': '成都管理措施生意 实拍街面防疫画面', 'url': 'http://k.sina.com.cn/article_7723381539_m1cc59732300100y7b6.html'}}, {'_index': 'news', '_type': '_doc', '_id': 'qsLVHH8BLpl_c_jRaLAq', '_score': 1.0, '_source': {'title': '呼和浩特本轮疫情已外溢3市，传播链达175人', 'url': 'http://news.sina.com.cn/o/2022-02-21/doc-imcwipih4526673.shtml'}}, {'_index': 'news', '_type': '_doc', '_id': 'q8LVHH8BLpl_c_jRaLAy', '_score': 1.0, '_source': {'title': '科普：“混打”新冠疫苗 你的理解对吗', 'url': 'http://news.sina.com.cn/o/2022-02-21/doc-imcwipih4528497.shtml'}}, {'_index': 'news', '_type': '_doc', '_id': 'rMLVHH8BLpl_c_jRaLA4', '_score': 1.0, '_source': {'title': '新冠疫苗“混打”加强针，要注意什么？', 'url': 'http://news.sina.com.cn/c/2022-02-21/doc-imcwiwss2009819.shtml'}}]}}
	
```
from elasticsearch import Elasticsearch

dsl = {
    'query':{
        'match':{
            'title':'混打 理解'
        }
    }
}
es = Elasticsearch()
result = es.search(index='news',body=dsl)
print(result)
```

	{'took': 12, 'timed_out': False, '_shards': {'total': 1, 'successful': 1, 'skipped': 0, 'failed': 0}, 'hits': {'total': {'value': 2, 'relation': 'eq'}, 'max_score': 1.9162399, 'hits': [{'_index': 'news', '_type': '_doc', '_id': 'q8LVHH8BLpl_c_jRaLAy', '_score': 1.9162399, '_source': {'title': '科普：“混打”新冠疫苗 你的理解对吗', 'url': 'http://news.sina.com.cn/o/2022-02-21/doc-imcwipih4528497.shtml'}}, {'_index': 'news', '_type': '_doc', '_id': 'rMLVHH8BLpl_c_jRaLA4', '_score': 0.7295435, '_source': {'title': '新冠疫苗“混打”加强针，要注意什么？', 'url': 'http://news.sina.com.cn/c/2022-02-21/doc-imcwiwss2009819.shtml'}}]}}

### RabbiMQ的使用
