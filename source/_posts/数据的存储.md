---
title: 数据的存储
date: 2022-02-16 14:49:53
tags:
---
## 前言
- 爬虫文章均来自《python3网络爬虫开发实战教程》，只为方便记录日常所学，以及方便观看。

## TXT文本文件存储
### 本节目标
我们以电影实例网站https://ssr1.scrape.center/为例，爬取首页10部电影的数据，然后将相关信息存储为TXT文本格式。

### 基本实例

```
import requests
from pyquery import PyQuery as pq
import re

url = 'http://ssr1.scrape.center'
html = requests.get(url).text
doc = pq(html)
items = doc('.el-card').items()
file = open('movie.txt','w',encoding='utf-8')
for item in items:
    # 电影名称
    name = item.find('a > h2').text()
    file.write(f"名称：{name} \n")
    # 类别
    categories = [item.text() for item in item.find('.categories button span').items()]
    file.write(f"类别：{categories} \n")
    # 上映时间
    publish_at = item.find('.info:contains(上映)').text()
    publish_at = re.search('(\d{4}-\d{2}-\d{2})',publish_at).group(1) if publish_at and re.search('(\d{4}-\d{2}-\d{2})',publish_at) else None
    file.write(f"上映时间：{publish_at}\n")
    # 评分
    score = item.find('p.score').text()
    file.write(f'评分：{score}\n')
    file.write(f'{"="*50}\n')
file.close()
```

	名称：霸王别姬 - Farewell My Concubine 
	类别：['剧情', '爱情'] 
	上映时间：1993-07-26
	评分：9.5
	==================================================
	名称：这个杀手不太冷 - Léon 
	类别：['剧情', '动作', '犯罪'] 
	上映时间：1994-09-14
	评分：9.5
	==================================================
	名称：肖申克的救赎 - The Shawshank Redemption 
	类别：['剧情', '犯罪'] 
	..........
	
### 打开方式
|模式|含义|
|:---:|:----:|
|`r`|以只读的方式打开一个文件，意思是只能读取文件内容，而不能写入。这也是默认模式|
|`w`|以写入方式打开一个文件。如果该文件已存在，则将其覆盖。如果改文件不存在，则创建新文件|
|`a`|以追加方式打开一个文件。如果该文件已存在，则文件指针将会放在文件末尾。也就是说，新的内容将会被写到已有内容之后。如果改文件不存在，则创建新文件来写入。|
|`b`|以二进制的方式打开一个文件|
|`+`|以读写的方式打开一个文件|
|常用|`r`、`rb`、`r+`、`rb+`、`w`、`wb`、`w+`、`wb+`、`a`、`ab`、`a+`、`ab+`|

```
with open('movie.txt','w',encoding='utf-8') as file:
    for item in items:
        # 电影名称
        name = item.find('a > h2').text()
        file.write(f"名称：{name} \n")
        # 类别
        categories = [item.text() for item in item.find('.categories button span').items()]
        file.write(f"类别：{categories} \n")
        # 上映时间
        publish_at = item.find('.info:contains(上映)').text()
        publish_at = re.search('(\d{4}-\d{2}-\d{2})',publish_at).group(1) if publish_at and re.search('(\d{4}-\d{2}-\d{2})',publish_at) else None
        file.write(f"上映时间：{publish_at}\n")
        # 评分
        score = item.find('p.score').text()
        file.write(f'评分：{score}\n')
        file.write(f'{"="*50}\n')
```

### 总结
## JSON文件储存
### 对象和数组
### 读取JSON
```
import json

str = """
[
  {
    "name": "Bob",
    "gender": "male",
    "birthday": "1992-10-18"
  },{
  "name": "Selina",
  "gender": "female",
  "birthday": "1995-10-18"
}
]
"""
print(type(str))
data = json.loads(str)
print(data)
print(type(data))
```

	<class 'str'>
	[{'name': 'Bob', 'gender': 'male', 'birthday': '1992-10-18'}, {'name': 'Selina', 'gender': 'female', 'birthday': '1995-10-18'}]
	<class 'list'>

```
print(data[0]['name'])
print(data[0].get('name'))
```

	Bob
	Bob
	
```
print(data[0].get('age'))
print(data[0].get('age',25))
```

```
import json

str = """
[
  {
    'name': 'Bob',
    'gender': 'male',
    'birthday': '1992-10-18'
  },{
  'name': 'Selina',
  'gender': 'female',
  'birthday: '1995-10-18
}
]
"""
data = json.loads(str)
```

	json.decoder.JSONDecodeError: Expecting property name enclosed in double quotes: line 4 column 5 (char 11)
	
```
import json
with open('test.json',encoding='utf-8') as file:
    str = file.read()
    data = json.loads(str)
    print(data)
```

	[{'name': 'Bob', 'gender': 'male', 'birthday': '1992-10-18'}, {'name': 'Selina', 'gender': 'female', 'birthday': '1995-10-18'}]
	
```
import json

data = json.load(open('test.json',encoding='utf-8'))
print(data)
```

### 输出JSON
```
import json

data = [
  {
    "name": "Bob",
    "gender": "male",
    "birthday": "1992-10-18"
  }
]
with open('data.json','w',encoding="utf-8") as file:
    file.write(json.dumps(data))
```

	[{"name": "Bob", "gender": "male", "birthday": "1992-10-18"}]

```
with open('data.json','w',encoding="utf-8") as file:
    file.write(json.dumps(data,indent=2))
```

	[
	  {
		"name": "Bob",
		"gender": "male",
		"birthday": "1992-10-18"
	  }
	]

```
import json

data = [
  {
    "name": "李四",
    "gender": "男",
    "birthday": "1992-10-18"
  }
]
with open('data.json','w',encoding="utf-8") as file:
    file.write(json.dumps(data,indent=2))
```

	[
	  {
		"name": "\u674e\u56db",
		"gender": "\u7537",
		"birthday": "1992-10-18"
	  }
	]

```
with open('data.json','w',encoding="utf-8") as file:
    file.write(json.dumps(data,indent=2,ensure_ascii=False))
```

	[
	  {
		"name": "李四",
		"gender": "男",
		"birthday": "1992-10-18"
	  }
	]
	
```
json.dump(data,open('data.json','w',encoding='utf-8'),indent=2,ensure_ascii=False)
```

## CSV文件存储
### 写入
```
import csv

with open('data.csv','w',newline='') as csvfile:
  writer = csv.writer(csvfile)
  writer.writerow(['id','name','age'])
  writer.writerow(['10001','Mike',20])
  writer.writerow(['10002','Bob',22])
  writer.writerow(['10003','Jordan',21])
```

	id,name,age
	10001,Mike,20
	10002,Bob,22
	10003,Jordan,21
	
```
import csv

with open('data.csv','w',newline='') as csvfile:
  writer = csv.writer(csvfile,delimiter=" ")
  writer.writerow(['id','name','age'])
  writer.writerow(['10001','Mike',20])
  writer.writerow(['10002','Bob',22])
  writer.writerow(['10003','Jordan',21])
```

	id name age
	10001 Mike 20
	10002 Bob 22
	10003 Jordan 21
	
```
import csv

with open('data.csv','w',newline='') as csvfile:
  writer = csv.writer(csvfile)
  writer.writerow(['id','name','age'])
  writer.writerows([['10001','mike',20],['10002','bob',22],['10003','lisa',21]])
```

	id,name,age
	10001,mike,20
	10002,bob,22
	10003,lisa,21

```bash
import csv

with open('data.csv','w',newline='') as csvfile:
  fieldnames = ['id','name','age']
  writer = csv.DictWriter(csvfile,fieldnames=fieldnames)
  writer.writeheader()
  writer.writerow({'id':'10001',"name":'Mike',"age":20})
  writer.writerow({'id':'10001',"name":'Bob',"age":22})
  writer.writerow({'id':'10001',"name":'Jordan',"age":24})
```

	id,name,age
	10001,Mike,20
	10001,Bob,22
	10001,Jordan,24

```bash
import csv

with open('data.csv','a',newline='') as csvfile:
  fieldnames = ['id','name','age']
  writer = csv.DictWriter(csvfile,fieldnames=fieldnames)
  writer.writerow({'id':'10004',"name":'Doubi',"age":20})
```

	id,name,age
	10001,Mike,20
	10001,Bob,22
	10001,Jordan,24
	10004,Doubi,20

```bash
import csv

with open('data.csv','a',newline='',encoding='utf-8') as csvfile:
  fieldnames = ['id','name','age']
  writer = csv.DictWriter(csvfile,fieldnames=fieldnames)
  writer.writerow({'id':'10001',"name":'李四',"age":20})
```

```bash
import pandas as pd

data = [
  {'id':'10001','name':'Mike','age':25},
  {'id': '10002', 'name': 'Bob', 'age': 22},
  {'id': '10003', 'name': 'lisa', 'age': 21},
]

df = pd.DataFrame(data)
df.to_csv('data.csv',index=False)
```
### 读取
```
import csv

with open('data.csv','r',encoding='utf-8') as csvfile:
  reader = csv.reader(csvfile)
  for row in reader:
    print(row)
```

	['id', 'name', 'age']
	['10001', 'Mike', '25']
	['10002', 'Bob', '22']
	['10003', 'lisa', '21']
	
```
import pandas as pd

df = pd.read_csv('data.csv')
print(df)
```

		  id  name  age
	0  10001  Mike   25
	1  10002   Bob   22
	2  10003  lisa   21
	
```bash
import pandas as pd

df = pd.read_csv('data.csv')
for index,row in df.iterrows():
  print(row.tolist())
```

	[10001, 'Mike', 25]
	[10002, 'Bob', 22]
	[10003, 'lisa', 21]
	
## MySQL 存储
### 准备工作
### 连接数据库
```bash
import pymysql

db = pymysql.connect(host='localhost',user='root',password='123456',port=3306)
cursor = db.cursor()
cursor.execute('select version()')
data = cursor.fetchone()
print('database version:',data)
cursor.execute('create database spiders default character set utf8mb4')
db.close()
```

	database version: ('8.0.26',)
	
### 创建表
```
import pymysql

db = pymysql.connect(host='localhost',user='root',password='123456',port=3306,db='spiders')
cursor = db.cursor()
sql = 'create table if not exists students(id varchar(255) not null,name varchar(255) not null,age int not null,primary key (id))'
cursor.execute(sql)
db.close()
```
### 插入数据
```
import pymysql

id = "2012001"
user = "Bob"
age = 20

db = pymysql.connect(host='localhost',user='root',password='1360630934wyh',port=3306,db='spiders')
cursor = db.cursor()
sql = 'insert into students(id,name,age) values (%s,%s,%s)'
try:
    cursor.execute(sql,(id,user,age))
    db.commit()
    print('插入成功')
except:
    print("插入失败")
    db.rollback()
db.close()
```

```
import pymysql

db = pymysql.connect(host='localhost',user='root',password='1360630934wyh',port=3306,db='spiders')
cursor = db.cursor()
data = {
    "id" : "2012001",
    "name" : "Bob",
    "age" : 20
}
table = "students"
keys = ','.join(data.keys())
values = ','.join(['%s']*len(data))
sql = "insert into {table}({keys}) values ({values})".format(table=table,keys=keys,values=values)
print("sql语句：",sql)
try:
    if cursor.execute(sql,tuple(data.values())):
        print("successful")
        db.commit()
except:
    print("failed")
    db.rollback()
db.close()
```

	sql语句： insert into students(id,name,age) values (%s,%s,%s)
	successful
	
### 更新数据
```
import pymysql

db = pymysql.connect(host='localhost',user='root',password='123456',port=3306,db='spiders')
cursor = db.cursor()
sql = "update students set age = %s where name = %s"
try:
    cursor.execute(sql,(25,'BOb'))
    db.commit()
except:
    db.rollback()
db.close()
```

```
import pymysql

db = pymysql.connect(host='localhost',user='root',password='1360630934wyh',port=3306,db='spiders')
cursor = db.cursor()
data = {
    'id':'20120001',
    'name':'Bob',
    'age':54
}

table = 'students'
keys = ','.join(data.keys())
values = ','.join(['%s']*len(data))
sql = 'insert into {table}({keys}) values ({values}) on duplicate key update '.format(table=table,keys=keys,values=values)
update = ','.join(["{key}=%s".format(key=key)for key in data])
sql += update
try:
    if cursor.execute(sql,tuple(data.values())*2):
        print('successful')
        db.commit()
    else:
        print('数据没有变化')
except:
    print('failed')
    db.rollback()
db.close()
```

`insert into students(id,name,age) values (%s,%s,%s) on duplicate key update id=%s,name=%s,age=%s`

### 删除数据
```
table = "students"
condition = 'age > 20'
sql = f'delete from {table} where {condition}'
try:
    cursor.execute(sql)
    db.commit()
except:
    db.rollback()
```

### 查询数据
```
import pymysql

db = pymysql.connect(host='localhost',user='root',password='1360630934wyh',port=3306,db='spiders')
cursor = db.cursor()
sql = "select * from students where age >=20"
try:
    cursor.execute(sql)
    print('Count:',cursor.rowcount)
    one = cursor.fetchone()
    print('One:',one)
    result = cursor.fetchall()
    print("result:",result)
    print("result type:",type(result))
    for row in result:
        print(row)
except:
    print("Error")
```

	Count: 4
	One: ('20120001', 'Bob', 25)
	result: (('20120011', 'Mary', 21), ('20120012', 'Mike', 20), ('20120013', 'James', 22))
	result type: <class 'tuple'>
	('20120011', 'Mary', 21)
	('20120012', 'Mike', 20)
	('20120013', 'James', 22)
	
```
sql = "select * from students where age >=20"
try:
    cursor.execute(sql)
    print('Count:',cursor.rowcount)
    row = cursor.fetchone()
    while row:
        print('Row:',row)
        row = cursor.fetchone()
except:
    print("Error")
```
### 总结

## MongoDB 文档存储
### 准备工作
### 连接MongoDB
```
import pymongo
client = pymongo.MongoClient(host='localhost',port=27017)
```
```
client = pymongo.MongoClient('mongodb://localhost:27017/')
```
### 指定数据库
`db = client.test`
`db = client['test']`
### 指定集合
`collection = db.students`
`collection = db['students']`
### 插入数据
```
student = {
    "id":'20170101',
    'name':'Jordan',
    'age':20,
    'gender':'male'
}
result = collection.insert_one(student)
print(result)
print()
```
```
import pymongo
client = pymongo.MongoClient(host='localhost',port=27017)
db = client['test']
collection = db.students
student = {
    "id":'20170101',
    'name':'Jordan',
    'age':20,
    'gender':'male'
}
student2 = {
    "id":'20170102',
    'name':'Jordan',
    'age':20,
    'gender':'male'
}
result = collection.insert_many([student,student2])
print(result)
print(result.inserted_ids)
```

	<pymongo.results.InsertManyResult object at 0x000001D5A8641180>
	[ObjectId('620dfd63bc30cd00a1871024'), ObjectId('620dfd63bc30cd00a1871025')]
	
### 查询
```
result = collection.find_one({'name':'Mike'})
print(type(result))
print(result)
```

	<class 'dict'>
	{'_id': ObjectId('620e097019ab150ec0383f86'), 'id': '20170102', 'name': 'Mike', 'age': 23, 'gender': 'male'}

```
from bson.objectid import ObjectId
result = collection.find_one({'_id':ObjectId('620e097019ab150ec0383f86')})
print(result)
```

	{'_id': ObjectId('620e097019ab150ec0383f86'), 'id': '20170102', 'name': 'Mike', 'age': 23, 'gender': 'male'}
	
```
results = collection.find({'age':20})
for result in results:
    print(result)
```

```
results = collection.find({'age':{'$gt':19}})
for result in results:
    print(result)
```

|符号|含义|实例|
|----|-----|-----|
|`$lt`|小于|{'age':{'$lt':20}}|
|`$gt`|大于|{'age':{'$gt':20}}|
|`$lte`|小于等于|{'age':{'$lte':20}}|
|`$gte`|大于等于|{'age':{'$gte':20}}|
|`$ne`|不等于|{'age':{'$ne':20}}|
|`$in`|在范围内|{'age':{'$in':20}}|
|`$nin`|小于|{'age':{'$nin':20}}|

```
results = collection.find({'name':{'$regex':'^M.*'}})
```

|符号|含义|实例|实例含义|
|----|----|----|-----|
|`$regex`|匹配正则表达式|{'name':{'$regex':'^M.*'}}|name以M开头|
|`$exists`|属性是否存在|{'name':{'$exists':True}}|存在name属性|
|`$type`|类型判断|{'age':{'$type':'int'}}|age的类型为 int|
|`$mod`|数字模操作|{'age':{'$mod':[5,0]}}|age模5余0|
|`$text`|文本查询|{'$text':{'$search':'Mike'}}|Mike字符串|
|`$where`|高级条件查询|{'$where':'obj.fans_count==obj.follows_count'}|自身粉丝数等于关注数|

### 排序
```
results = collection.find().sort('name',pymongo.ASCENDING)
print([result['name'] for result in results])
```

	['Jordan', 'Mike']
	
### 偏移
```
results = collection.find().sort('name',pymongo.ASCENDING).skip(1)
print([result['name'] for result in results])
```

	['Mike']
	
```
results = collection.find().sort('name',pymongo.ASCENDING).limit(1)
print([result['name'] for result in results])
```

	['Jordan']
	
### 更新
```
condition = {'name':'Mike'}
student = collection.find_one(condition)
student['age'] = 25
result = collection.update_one(condition,{'$set':student})
print(result)
print(result.matched_count,result.modified_count)
```

```
condition = {'age':{'$gt':20}}
result = collection.update_one(condition,{'$inc':{'age':1}})
print(result)
print(result.matched_count,result.modified_count)
```

	<pymongo.results.UpdateResult object at 0x0000016BB4CB6E00>
	1 1
	
```
condition = {'age':{'$gt':20}}
result = collection.update_many(condition,{'$inc':{'age':1}})
print(result)
print(result.matched_count,result.modified_count)
```

	<pymongo.results.UpdateResult object at 0x000002B692982380>
	2 2
	
### 删除
```
result = collection.delete_one({'name':"Kevin"})
print(result)
print(result.deleted_count)
result = collection.delete_many({'age':{'$lt':25}})
print(result.deleted_count)
```

	<pymongo.results.DeleteResult object at 0x0000018CAA827EC0>
	0
	1
	
### 其他操作
### 总结


## Redis 缓存存储
### 准备工作
`pip install redis`
### Redis 和StrickRedis
### 连接Redis
```
from redis import StrictRedis
redis = StrictRedis(host="localhost",port=6379,db=0,password='1269305589wyh')
redis.set('name','Bob')
print(redis.get('name'))
```

	b'Bob'
	
```
pool = ConnectionPool(host="localhost",port=6379,db=0,password="1269305589wyh")
redis = StrictRedis(connection_pool=pool)
print(redis.get('name'))
```

`redis://[:password]@host:port/db`
`rediss://[:password]@host:port/db`
`unix://[:password]@/path/to/socket.sock?db=db`

```
url = "redis://:1269305589wyh@localhost:6379/0"
pool = ConnectionPool.from_url(url)
redis = StrictRedis(connection_pool=pool)
print(redis.get('name'))
```

|方法|作用|参数说明|实例|实例说明|实例结果|
|---|----|-------|-----|-------|--------|
|`exists(name)`|判断一个键是否存在|name:键名|`redis.exists('name')`|是否存在那么这个键|1|
|`delete(name)`|删除一个键|name:键名|`redis.delete('name')`|删除name这个键|1|
|`type(name)`|判断键类型|name:键名|`redis.type('name')`|判断name这个键的类型|b'string'|



|方法|作用|参数说明|实例|实例说明|实例结果|
|-----|-----|-----|----|------|------|
|`set(name,vlaue)`|将数据库中制定键名对应的键值赋值为字符串value|name:键名value:键值|redis.set('name','Bob')|将name这个键对应的键值赋值为Bob|True|	
|