---
title: 数据的存储
date: 2022-02-16 14:49:53
tags:
---
## 前言
- 爬虫文章均来自《python3网络爬虫开发实战教程》，只为方便记录日常所学，以及方便观看。

## TXT文本文件存储
### 本节目标
我们以电影实例网站https://ssr1.scrape.center/为例，爬取首页10部电影的数据，然后将相关信息存储为TXT文本格式。

### 基本实例

```
import requests
from pyquery import PyQuery as pq
import re

url = 'http://ssr1.scrape.center'
html = requests.get(url).text
doc = pq(html)
items = doc('.el-card').items()
file = open('movie.txt','w',encoding='utf-8')
for item in items:
    # 电影名称
    name = item.find('a > h2').text()
    file.write(f"名称：{name} \n")
    # 类别
    categories = [item.text() for item in item.find('.categories button span').items()]
    file.write(f"类别：{categories} \n")
    # 上映时间
    publish_at = item.find('.info:contains(上映)').text()
    publish_at = re.search('(\d{4}-\d{2}-\d{2})',publish_at).group(1) if publish_at and re.search('(\d{4}-\d{2}-\d{2})',publish_at) else None
    file.write(f"上映时间：{publish_at}\n")
    # 评分
    score = item.find('p.score').text()
    file.write(f'评分：{score}\n')
    file.write(f'{"="*50}\n')
file.close()
```

	名称：霸王别姬 - Farewell My Concubine 
	类别：['剧情', '爱情'] 
	上映时间：1993-07-26
	评分：9.5
	==================================================
	名称：这个杀手不太冷 - Léon 
	类别：['剧情', '动作', '犯罪'] 
	上映时间：1994-09-14
	评分：9.5
	==================================================
	名称：肖申克的救赎 - The Shawshank Redemption 
	类别：['剧情', '犯罪'] 
	..........
	
### 打开方式
|模式|含义|
|:---:|:----:|
|`r`|以只读的方式打开一个文件，意思是只能读取文件内容，而不能写入。这也是默认模式|
|`w`|以写入方式打开一个文件。如果该文件已存在，则将其覆盖。如果改文件不存在，则创建新文件|
|`a`|以追加方式打开一个文件。如果该文件已存在，则文件指针将会放在文件末尾。也就是说，新的内容将会被写到已有内容之后。如果改文件不存在，则创建新文件来写入。|
|`b`|以二进制的方式打开一个文件|
|`+`|以读写的方式打开一个文件|
|常用|`r`、`rb`、`r+`、`rb+`、`w`、`wb`、`w+`、`wb+`、`a`、`ab`、`a+`、`ab+`|

```
with open('movie.txt','w',encoding='utf-8') as file:
    for item in items:
        # 电影名称
        name = item.find('a > h2').text()
        file.write(f"名称：{name} \n")
        # 类别
        categories = [item.text() for item in item.find('.categories button span').items()]
        file.write(f"类别：{categories} \n")
        # 上映时间
        publish_at = item.find('.info:contains(上映)').text()
        publish_at = re.search('(\d{4}-\d{2}-\d{2})',publish_at).group(1) if publish_at and re.search('(\d{4}-\d{2}-\d{2})',publish_at) else None
        file.write(f"上映时间：{publish_at}\n")
        # 评分
        score = item.find('p.score').text()
        file.write(f'评分：{score}\n')
        file.write(f'{"="*50}\n')
```

### 总结
## JSON文件储存
### 对象和数组
### 读取JSON
```
import json

str = """
[
  {
    "name": "Bob",
    "gender": "male",
    "birthday": "1992-10-18"
  },{
  "name": "Selina",
  "gender": "female",
  "birthday": "1995-10-18"
}
]
"""
print(type(str))
data = json.loads(str)
print(data)
print(type(data))
```

	<class 'str'>
	[{'name': 'Bob', 'gender': 'male', 'birthday': '1992-10-18'}, {'name': 'Selina', 'gender': 'female', 'birthday': '1995-10-18'}]
	<class 'list'>

```
print(data[0]['name'])
print(data[0].get('name'))
```

	Bob
	Bob
	
```
print(data[0].get('age'))
print(data[0].get('age',25))
```

```
import json

str = """
[
  {
    'name': 'Bob',
    'gender': 'male',
    'birthday': '1992-10-18'
  },{
  'name': 'Selina',
  'gender': 'female',
  'birthday: '1995-10-18
}
]
"""
data = json.loads(str)
```

	json.decoder.JSONDecodeError: Expecting property name enclosed in double quotes: line 4 column 5 (char 11)
	
```
import json
with open('test.json',encoding='utf-8') as file:
    str = file.read()
    data = json.loads(str)
    print(data)
```

	[{'name': 'Bob', 'gender': 'male', 'birthday': '1992-10-18'}, {'name': 'Selina', 'gender': 'female', 'birthday': '1995-10-18'}]
	
```
import json

data = json.load(open('test.json',encoding='utf-8'))
print(data)
```

### 输出JSON
```
import json

data = [
  {
    "name": "Bob",
    "gender": "male",
    "birthday": "1992-10-18"
  }
]
with open('data.json','w',encoding="utf-8") as file:
    file.write(json.dumps(data))
```

	[{"name": "Bob", "gender": "male", "birthday": "1992-10-18"}]

```
with open('data.json','w',encoding="utf-8") as file:
    file.write(json.dumps(data,indent=2))
```

	[
	  {
		"name": "Bob",
		"gender": "male",
		"birthday": "1992-10-18"
	  }
	]

```
import json

data = [
  {
    "name": "李四",
    "gender": "男",
    "birthday": "1992-10-18"
  }
]
with open('data.json','w',encoding="utf-8") as file:
    file.write(json.dumps(data,indent=2))
```

	[
	  {
		"name": "\u674e\u56db",
		"gender": "\u7537",
		"birthday": "1992-10-18"
	  }
	]

```
with open('data.json','w',encoding="utf-8") as file:
    file.write(json.dumps(data,indent=2,ensure_ascii=False))
```

	[
	  {
		"name": "李四",
		"gender": "男",
		"birthday": "1992-10-18"
	  }
	]
	
```
json.dump(data,open('data.json','w',encoding='utf-8'),indent=2,ensure_ascii=False)
```

## CSV文件存储
### 写入
```
import csv

with open('data.csv','w',newline='') as csvfile:
  writer = csv.writer(csvfile)
  writer.writerow(['id','name','age'])
  writer.writerow(['10001','Mike',20])
  writer.writerow(['10002','Bob',22])
  writer.writerow(['10003','Jordan',21])
```

	id,name,age
	10001,Mike,20
	10002,Bob,22
	10003,Jordan,21
	
```
import csv

with open('data.csv','w',newline='') as csvfile:
  writer = csv.writer(csvfile,delimiter=" ")
  writer.writerow(['id','name','age'])
  writer.writerow(['10001','Mike',20])
  writer.writerow(['10002','Bob',22])
  writer.writerow(['10003','Jordan',21])
```

	id name age
	10001 Mike 20
	10002 Bob 22
	10003 Jordan 21
	
```
import csv

with open('data.csv','w',newline='') as csvfile:
  writer = csv.writer(csvfile)
  writer.writerow(['id','name','age'])
  writer.writerows([['10001','mike',20],['10002','bob',22],['10003','lisa',21]])
```

	id,name,age
	10001,mike,20
	10002,bob,22
	10003,lisa,21

```bash
import csv

with open('data.csv','w',newline='') as csvfile:
  fieldnames = ['id','name','age']
  writer = csv.DictWriter(csvfile,fieldnames=fieldnames)
  writer.writeheader()
  writer.writerow({'id':'10001',"name":'Mike',"age":20})
  writer.writerow({'id':'10001',"name":'Bob',"age":22})
  writer.writerow({'id':'10001',"name":'Jordan',"age":24})
```

	id,name,age
	10001,Mike,20
	10001,Bob,22
	10001,Jordan,24

```bash
import csv

with open('data.csv','a',newline='') as csvfile:
  fieldnames = ['id','name','age']
  writer = csv.DictWriter(csvfile,fieldnames=fieldnames)
  writer.writerow({'id':'10004',"name":'Doubi',"age":20})
```

	id,name,age
	10001,Mike,20
	10001,Bob,22
	10001,Jordan,24
	10004,Doubi,20

```bash
import csv

with open('data.csv','a',newline='',encoding='utf-8') as csvfile:
  fieldnames = ['id','name','age']
  writer = csv.DictWriter(csvfile,fieldnames=fieldnames)
  writer.writerow({'id':'10001',"name":'李四',"age":20})
```

```bash
import pandas as pd

data = [
  {'id':'10001','name':'Mike','age':25},
  {'id': '10002', 'name': 'Bob', 'age': 22},
  {'id': '10003', 'name': 'lisa', 'age': 21},
]

df = pd.DataFrame(data)
df.to_csv('data.csv',index=False)
```
### 读取
```
import csv

with open('data.csv','r',encoding='utf-8') as csvfile:
  reader = csv.reader(csvfile)
  for row in reader:
    print(row)
```

	['id', 'name', 'age']
	['10001', 'Mike', '25']
	['10002', 'Bob', '22']
	['10003', 'lisa', '21']
	
```
import pandas as pd

df = pd.read_csv('data.csv')
print(df)
```

		  id  name  age
	0  10001  Mike   25
	1  10002   Bob   22
	2  10003  lisa   21
	
```bash
import pandas as pd

df = pd.read_csv('data.csv')
for index,row in df.iterrows():
  print(row.tolist())
```

	[10001, 'Mike', 25]
	[10002, 'Bob', 22]
	[10003, 'lisa', 21]
	
## MySQL 存储
### 准备工作
### 连接数据库
```bash
import pymysql

db = pymysql.connect(host='localhost',user='root',password='123456',port=3306)
cursor = db.cursor()
cursor.execute('select version()')
data = cursor.fetchone()
print('database version:',data)
cursor.execute('create database spiders default character set utf8mb4')
db.close()
```

	database version: ('8.0.26',)
	
### 创建表
```
import pymysql

db = pymysql.connect(host='localhost',user='root',password='123456',port=3306,db='spiders')
cursor = db.cursor()
sql = 'create table if not exists students(id varchar(255) not null,name varchar(255) not null,age int not null,primary key (id))'
cursor.execute(sql)
db.close()
```
### 插入数据
```
import pymysql

id = "2012001"
user = "Bob"
age = 20

db = pymysql.connect(host='localhost',user='root',password='1360630934wyh',port=3306,db='spiders')
cursor = db.cursor()
sql = 'insert into students(id,name,age) values (%s,%s,%s)'
try:
    cursor.execute(sql,(id,user,age))
    db.commit()
    print('插入成功')
except:
    print("插入失败")
    db.rollback()
db.close()
```

```
import pymysql

db = pymysql.connect(host='localhost',user='root',password='1360630934wyh',port=3306,db='spiders')
cursor = db.cursor()
data = {
    "id" : "2012001",
    "name" : "Bob",
    "age" : 20
}
table = "students"
keys = ','.join(data.keys())
values = ','.join(['%s']*len(data))
sql = "insert into {table}({keys}) values ({values})".format(table=table,keys=keys,values=values)
print("sql语句：",sql)
try:
    if cursor.execute(sql,tuple(data.values())):
        print("successful")
        db.commit()
except:
    print("failed")
    db.rollback()
db.close()
```

	sql语句： insert into students(id,name,age) values (%s,%s,%s)
	successful